
       <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>الطريق الذكي الزهراني | نظام إدارة الأسطول المتطور مع الذكاء الاصطناعي</title>
    
    <!-- Firebase SDK v10.8.0 -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- TensorFlow.js للذكاء الاصطناعي -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.1/dist/mobilenet.min.js"></script>
    
    <!-- AOS Animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    
    <style>
        /* ==================================================================== */
        /* FANTASY PROFESSIONAL DESIGN – الطريق الذكي الزهراني مع AI مباشر      */
        /* ==================================================================== */
        
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap');
        
        :root {
            --primary-deep: #0a1a2f;
            --primary-night: #0e2a47;
            --primary-royal: #1a3e60;
            --primary-ocean: #2a5f7a;
            --accent-glow: #3fa3d6;
            --accent-electric: #38bdf8;
            --success-emerald: #10b981;
            --warning-amber: #f59e0b;
            --danger-coral: #ef4444;
            --danger-deep: #dc2626;
            --info-sky: #0ea5e9;
            --white-pure: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            
            --shadow-glass: 0 8px 32px 0 rgba(0,0,0,0.36);
            --shadow-neon: 0 0 20px rgba(56, 189, 248, 0.5);
            --border-radius-xl: 1.5rem;
            --border-radius-lg: 1rem;
            --border-radius-md: 0.75rem;
            --border-radius-full: 9999px;
            
            --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: radial-gradient(circle at 10% 20%, var(--primary-deep), #051220);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .hero-section {
            position: relative;
            width: 100%;
            height: 100vh;
            min-height: 700px;
            overflow: hidden;
            border-radius: 0 0 var(--border-radius-xl) var(--border-radius-xl);
            margin-bottom: 30px;
        }
        
        .hero-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        
        .hero-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(10, 26, 47, 0.8) 0%, rgba(5, 18, 32, 0.95) 100%);
            z-index: 2;
        }
        
        .hero-content {
            position: relative;
            z-index: 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: white;
            text-align: center;
            padding: 0 20px;
        }
        
        .hero-title {
            font-size: 64px;
            font-weight: 900;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(56, 189, 248, 0.7);
        }
        
        .hero-title span {
            color: var(--accent-electric);
            position: relative;
        }
        
        .hero-subtitle {
            font-size: 24px;
            margin-bottom: 40px;
            opacity: 0.9;
            max-width: 800px;
        }
        
        .hero-btn {
            padding: 16px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(145deg, var(--accent-electric), var(--accent-glow));
            color: white;
            box-shadow: 0 0 30px rgba(56,189,248,0.5);
        }
        
        /* ==================================================================== */
        /* MEDIA CAPTURE STYLES                                                */
        /* ==================================================================== */
        .media-capture-container {
            margin-bottom: 25px;
            border: 2px dashed var(--gray-300);
            border-radius: 24px;
            padding: 20px;
            background: rgba(255,255,255,0.8);
        }
        
        .camera-preview {
            width: 100%;
            height: 240px;
            object-fit: cover;
            border-radius: 16px;
            background: var(--gray-900);
            margin-bottom: 15px;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .capture-btn {
            padding: 12px 20px;
            border-radius: 50px;
            border: none;
            background: var(--primary-royal);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .capture-btn:hover {
            background: var(--accent-electric);
            transform: scale(1.05);
        }
        
        .capture-btn.video {
            background: var(--danger-coral);
        }
        
        .capture-btn.active {
            background: var(--success-emerald);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .media-thumbnails {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .media-thumb {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            object-fit: cover;
            border: 3px solid var(--accent-electric);
            position: relative;
        }
        
        .media-thumb.video {
            border-color: var(--danger-coral);
        }
        
        .media-label {
            position: absolute;
            bottom: -25px;
            right: 0;
            font-size: 12px;
            color: var(--gray-600);
            font-weight: 700;
        }
        
        .location-badge {
            background: linear-gradient(145deg, var(--success-emerald), #0b8a5c);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .ai-analysis-badge {
            background: linear-gradient(145deg, #6366f1, #4f46e5);
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        .suspicious-alert {
            background: #ffebe6;
            border-right: 6px solid var(--danger-coral);
            padding: 20px;
            border-radius: 16px;
            margin: 15px 0;
            animation: shake 0.5s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .suspicious-alert i {
            color: var(--danger-coral);
            font-size: 24px;
            margin-left: 10px;
        }
        
        .language-orb {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 99999;
            width: 58px;
            height: 58px;
            border-radius: 50%;
            background: linear-gradient(145deg, var(--primary-royal), var(--primary-night));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            transition: var(--transition-smooth);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .language-orb:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 15px 35px rgba(56,189,248,0.4);
        }
        
        .language-orb i {
            font-size: 28px;
            color: white;
            text-shadow: 0 0 15px var(--accent-electric);
        }
        
        .language-tooltip {
            position: absolute;
            top: 70px;
            left: 0;
            background: rgba(10, 26, 47, 0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 40px;
            padding: 12px 28px;
            color: white;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: var(--shadow-glass);
            pointer-events: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: var(--transition-smooth);
        }
        
        .language-orb:hover .language-tooltip {
            opacity: 1;
            transform: translateY(0);
        }
        
        .lang-menu {
            position: fixed;
            top: 100px;
            left: 20px;
            background: rgba(10, 26, 47, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 40px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 9999;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .lang-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .lang-option.active {
            background: var(--accent-electric);
            box-shadow: 0 0 20px var(--accent-electric);
        }
        
        .oval-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .oval-bg {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 30%, var(--accent-glow), var(--primary-royal));
            border-radius: 50% / 40% 40% 40% 40%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }
        
        .oval-icon {
            position: relative;
            z-index: 3;
            color: white;
            text-shadow: 0 0 30px rgba(56,189,248,0.8);
        }
        
        .oval-logo.small { width: 50px; height: 50px; }
        .oval-logo.medium { width: 80px; height: 80px; }
        .oval-logo.large { width: 120px; height: 120px; }
        .oval-logo.xlarge { width: 160px; height: 160px; }
        
        .splash-screen {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, #0a2a44, #04111f);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999999;
            transition: opacity 0.7s ease;
        }
        
        .splash-content {
            text-align: center;
            animation: float 3s infinite ease-in-out;
        }
        
        @keyframes float {
            0%,100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        .loader-pro {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: var(--accent-electric);
            border-top-color: var(--accent-glow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .page { display: none; animation: fadePage 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadePage { from { opacity: 0.3; } to { opacity: 1; } }
        
        .hidden { display: none !important; }
        
        .floating-group {
            position: relative;
            margin-bottom: 25px;
        }
        
        .floating-input {
            width: 100%;
            padding: 18px 20px;
            padding-right: 55px;
            border: 2px solid var(--gray-200);
            border-radius: 18px;
            font-size: 15px;
            transition: var(--transition-smooth);
            background: rgba(255,255,255,0.9);
        }
        
        .floating-input:focus {
            border-color: var(--accent-electric);
            box-shadow: 0 0 0 4px rgba(56,189,248,0.2);
            outline: none;
        }
        
        .floating-label {
            position: absolute;
            right: 55px;
            top: 18px;
            color: var(--gray-500);
            transition: 0.2s;
            pointer-events: none;
        }
        
        .floating-input:focus ~ .floating-label,
        .floating-input:not(:placeholder-shown) ~ .floating-label {
            top: -10px;
            right: 45px;
            font-size: 12px;
            font-weight: 700;
            color: var(--primary-royal);
            background: white;
            padding: 0 8px;
            border-radius: 20px;
        }
        
        .input-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-500);
            font-size: 18px;
        }
        
        .btn-primary {
            background: linear-gradient(145deg, var(--primary-royal), var(--primary-night));
            border: none;
            padding: 16px 32px;
            border-radius: 50px;
            color: white;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            font-size: 16px;
            transition: var(--transition-smooth);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background: linear-gradient(145deg, var(--accent-glow), var(--primary-ocean));
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(56,189,248,0.5);
        }
        
        .btn-danger {
            background: linear-gradient(145deg, var(--danger-coral), #b91c1c);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 48px;
            box-shadow: var(--shadow-glass);
        }
        
        .admin-container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .admin-header {
            background: rgba(10, 26, 47, 0.8);
            backdrop-filter: blur(20px);
            padding: 20px 30px;
            border-radius: 60px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }
        
        .stat-card {
            background: white;
            border-radius: 28px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            transition: var(--transition-smooth);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-glass);
        }
        
        .stat-card i {
            font-size: 36px;
            color: var(--primary-royal);
            margin-bottom: 15px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 700;
        }
        
        .status-badge.pending { background: #fff3cd; color: #856404; }
        .status-badge.approved { background: #d4edda; color: #155724; }
        .status-badge.rejected { background: #f8d7da; color: #721c24; }
        .status-badge.suspicious { background: #ffebe6; color: #b91c1c; border-right: 4px solid #ef4444; }
        .status-badge.normal { background: #d4edda; color: #155724; }
        
        .delegates-table, .operations-table, .suspicious-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 28px;
            overflow: hidden;
        }
        
        .delegates-table th, .operations-table th, .suspicious-table th {
            background: var(--gray-100);
            padding: 16px;
            text-align: center;
            font-weight: 700;
        }
        
        .delegates-table td, .operations-table td, .suspicious-table td {
            padding: 14px;
            text-align: center;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .action-btn {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            border: none;
            color: white;
            cursor: pointer;
            margin: 0 4px;
            transition: var(--transition-smooth);
        }
        
        .action-btn:hover { transform: scale(1.1); }
        
        .tab-container {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 12px 30px;
            border-radius: 50px;
            border: none;
            background: var(--gray-200);
            color: var(--gray-700);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        
        .tab-btn.active {
            background: var(--accent-electric);
            color: white;
        }
        
        .ai-badge {
            background: linear-gradient(145deg, #6366f1, #4f46e5);
            color: white;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .geo-badge {
            background: linear-gradient(145deg, var(--success-emerald), #0b8a5c);
            color: white;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .install-banner {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(145deg, var(--primary-royal), var(--primary-deep));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 60px;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            box-shadow: var(--shadow-glass);
            z-index: 99999;
            animation: slideUp 0.5s ease;
            max-width: 600px;
            margin: 0 auto;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .install-btn {
            background: var(--accent-electric);
            border: none;
            padding: 12px 28px;
            border-radius: 50px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-install {
            background: rgba(255,255,255,0.1);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
        }
        
        @media (max-width: 992px) {
            .hero-title { font-size: 48px; }
            .hero-subtitle { font-size: 20px; }
            .admin-header { flex-direction: column; gap: 15px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 768px) {
            .hero-title { font-size: 36px; }
            .hero-subtitle { font-size: 18px; }
            .stats-grid { grid-template-columns: 1fr; }
            .camera-preview { height: 180px; }
        }
    </style>
</head>
<body>
    <!-- ========================================== -->
    <!-- LANGUAGE SWITCHER                         -->
    <!-- ========================================== -->
    <div id="languageOrb" class="language-orb">
        <i class="fas fa-globe"></i>
        <span class="language-tooltip" id="currentLangLabel">اللغة: العربية</span>
    </div>
    
    <div id="langSideMenu" class="lang-menu">
        <div id="langAr" class="lang-option active" data-lang="ar">ع</div>
        <div id="langEn" class="lang-option" data-lang="en">EN</div>
    </div>

    <!-- ========================================== -->
    <!-- SPLASH SCREEN                             -->
    <!-- ========================================== -->
    <div id="splash" class="splash-screen">
        <div class="splash-content">
            <div class="oval-logo xlarge">
                <div class="oval-bg">
                    <i class="fas fa-road oval-icon"></i>
                </div>
            </div>
            <div class="loader-pro"></div>
            <h1 class="splash-title" style="color: white; font-size: 42px; font-weight: 900;" data-translate="splashTitle">الطريق الذكي</h1>
            <p style="color: rgba(255,255,255,0.9); font-size: 24px; font-weight: 700;" data-translate="splashSubtitle">الزهراني</p>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- MAIN APPLICATION                          -->
    <!-- ========================================== -->
    <div id="appMain" class="app hidden">
        
        <!-- ====================================== -->
        <!-- HERO SECTION                          -->
        <!-- ====================================== -->
        <section class="hero-section">
            <video class="hero-video" autoplay muted loop playsinline>
                <source src="https://res.cloudinary.com/dzukfybwr/video/upload/v1770894287/12_nhxuiu.mp4" type="video/mp4">
            </video>
            <div class="hero-overlay"></div>
            
            <div class="hero-content">
                <div class="hero-logo">
                    <div class="oval-logo xlarge">
                        <div class="oval-bg">
                            <i class="fas fa-road oval-icon"></i>
                        </div>
                    </div>
                </div>
                
                <h1 class="hero-title" data-aos="fade-up" data-translate="heroTitle">
                    <span>الطريق الذكي</span> الزهراني
                </h1>
                
                <p class="hero-subtitle" data-aos="fade-up" data-aos-delay="200" data-translate="heroSubtitle">
                    نظام متكامل لإدارة عمليات التعبئة مع التحليل الذكي للصور والفيديو وتحديد الموقع الجغرافي
                </p>
                
                <button id="heroLoginBtn" class="hero-btn" data-aos="fade-up" data-aos-delay="400" data-translate="heroBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    دخول المندوبين
                </button>
            </div>
        </section>

        <!-- ====================================== -->
        <!-- PAGE: DELEGATE LOGIN                  -->
        <!-- ====================================== -->
        <div id="pageDelegateLogin" class="page">
            <div style="display: flex; align-items: center; justify-content: center; min-height: 85vh; padding: 20px;">
                <div class="glass-card" style="max-width: 480px; width: 100%; padding: 40px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div class="oval-logo large" style="margin: 0 auto 15px;">
                            <div class="oval-bg">
                                <i class="fas fa-user-tie oval-icon"></i>
                            </div>
                        </div>
                        <h2 style="color: var(--primary-deep); font-weight: 800;" data-translate="loginTitle">تسجيل الدخول</h2>
                    </div>
                    
                    <form id="delegateLoginForm">
                        <div class="floating-group">
                            <input type="email" id="loginEmail" class="floating-input" placeholder=" " required>
                            <label for="loginEmail" class="floating-label" data-translate="email">البريد الإلكتروني</label>
                            <i class="fas fa-envelope input-icon"></i>
                        </div>
                        
                        <div class="floating-group">
                            <input type="password" id="loginPassword" class="floating-input" placeholder=" " required>
                            <label for="loginPassword" class="floating-label" data-translate="password">كلمة المرور</label>
                            <i class="fas fa-lock input-icon"></i>
                            <i class="fas fa-eye toggle-password"></i>
                        </div>
                        
                        <button type="submit" class="btn-primary" style="margin-top: 15px;" data-translate="loginBtn">
                            دخول
                        </button>
                    </form>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button id="showSignupBtn" style="background: none; border: none; color: var(--primary-royal); font-weight: 700;" data-translate="newDelegate">
                            <i class="fas fa-user-plus"></i> مندوب جديد؟ سجل الآن
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; border-top: 1px solid var(--gray-200); padding-top: 20px; text-align: center;">
                        <span style="color: var(--gray-600); font-weight: 600;">
                            <i class="fas fa-user-shield"></i> دخول المدير المسؤول
                        </span>
                        <span style="margin: 0 10px; color: var(--gray-400);">|</span>
                        <a href="#" id="backToHeroBtn" style="color: var(--gray-600); font-weight: 600;" data-translate="home">
                            <i class="fas fa-home"></i> الرئيسية
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- ====================================== -->
        <!-- PAGE: DELEGATE SIGNUP                 -->
        <!-- ====================================== -->
        <div id="pageDelegateSignup" class="page">
            <div style="display: flex; justify-content: center; align-items: center; min-height: 85vh; padding: 20px;">
                <div class="glass-card" style="max-width: 600px; width: 100%; padding: 40px;">
                    <div style="text-align: center;">
                        <div class="oval-logo medium" style="margin: 0 auto;">
                            <div class="oval-bg"><i class="fas fa-user-plus oval-icon"></i></div>
                        </div>
                        <h2 style="color: var(--primary-deep);" data-translate="signupTitle">تسجيل جديد</h2>
                    </div>
                    
                    <form id="signupForm">
                        <div class="floating-group">
                            <input type="text" id="signupName" class="floating-input" placeholder=" " required>
                            <label class="floating-label" data-translate="fullName">الاسم الكامل</label>
                            <i class="fas fa-user input-icon"></i>
                        </div>
                        
                        <div class="floating-group">
                            <input type="email" id="signupEmail" class="floating-input" placeholder=" " required>
                            <label class="floating-label" data-translate="email">البريد الإلكتروني</label>
                            <i class="fas fa-envelope input-icon"></i>
                        </div>
                        
                        <div class="floating-group">
                            <input type="password" id="signupPassword" class="floating-input" placeholder=" " minlength="6" required>
                            <label class="floating-label" data-translate="password">كلمة المرور</label>
                            <i class="fas fa-lock input-icon"></i>
                            <i class="fas fa-eye toggle-password"></i>
                        </div>
                        
                        <div class="floating-group">
                            <select id="signupProject" class="floating-input" style="appearance: none;" required>
                                <option value="" disabled selected data-translate="selectProject">اختر المشروع</option>
                                <option value="مناديل">مناديل</option>
                                <option value="ناقل">ناقل</option>
                                <option value="كيمارت">كيمارت</option>
                                <option value="المراعي">المراعي</option>
                                <option value="ارامكس">ارامكس</option>
                                <option value="الطريق الذكي">الطريق الذكي</option>
                                <option value="manual" data-translate="otherProject">➕ مشروع آخر</option>
                            </select>
                            <i class="fas fa-building input-icon"></i>
                        </div>
                        
                        <div id="signupManualProjectContainer" class="floating-group hidden">
                            <input type="text" id="signupManualProject" class="floating-input" placeholder=" ">
                            <label class="floating-label" data-translate="enterProject">أدخل اسم المشروع</label>
                        </div>
                        
                        <div class="floating-group">
                            <select id="signupRegion" class="floating-input" required>
                                <option value="" disabled selected data-translate="selectRegion">اختر المنطقة</option>
                                <option value="الرياض">الرياض</option>
                                <option value="مكة">مكة</option>
                                <option value="الشرقية">الشرقية</option>
                                <option value="جدة">جدة</option>
                                <option value="الدمام">الدمام</option>
                                <option value="تبوك">تبوك</option>
                                <option value="القصيم">القصيم</option>
                                <option value="عسير">عسير</option>
                                <option value="manual" data-translate="otherRegion">➕ منطقة أخرى</option>
                            </select>
                            <i class="fas fa-map-marker-alt input-icon"></i>
                        </div>
                        
                        <div id="signupManualRegionContainer" class="floating-group hidden">
                            <input type="text" id="signupManualRegion" class="floating-input" placeholder=" ">
                            <label class="floating-label" data-translate="enterRegion">أدخل اسم المنطقة</label>
                        </div>
                        
                        <div class="floating-group">
                            <select id="signupFuelType" class="floating-input" style="appearance: none;" required>
                                <option value="" disabled selected data-translate="selectFuel">اختر نوع الوقود</option>
                                <option value="ديزل">⛽ ديزل</option>
                                <option value="91">⛽ بنزين 91</option>
                            </select>
                            <i class="fas fa-oil-can input-icon"></i>
                        </div>
                        
                        <div style="margin: 25px 0;">
                            <label style="display: flex; align-items: center; gap: 12px; background: var(--gray-50); padding: 15px; border-radius: var(--border-radius-lg);">
                                <input type="checkbox" id="agreeTerms" required style="width: 20px; height: 20px;">
                                <span style="color: var(--gray-700); font-weight: 600;" data-translate="agreeTerms">أوافق على الشروط والأحكام</span>
                            </label>
                        </div>
                        
                        <button type="submit" class="btn-primary" data-translate="signupBtn">
                            <i class="fas fa-paper-plane"></i> تقديم الطلب
                        </button>
                    </form>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <a href="#" id="backToLoginBtn" style="color: var(--gray-600); font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                            <i class="fas fa-arrow-right"></i> <span data-translate="backToLogin">العودة لتسجيل الدخول</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- ====================================== -->
        <!-- PAGE: DELEGATE REFUEL - 3 صور فقط + فيديو + موقع -->
        <!-- ====================================== -->
        <div id="pageDelegateRefuel" class="page">
            <div style="display: flex; align-items: center; justify-content: center; min-height: 85vh; padding: 20px;">
                <div class="glass-card" style="max-width: 800px; width: 100%; padding: 40px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div class="oval-logo large" style="margin: 0 auto 15px;">
                            <div class="oval-bg">
                                <i class="fas fa-gas-pump oval-icon"></i>
                            </div>
                        </div>
                        <h2 style="color: var(--primary-deep); font-weight: 800;" data-translate="refuelTitle">تعبئة جديدة</h2>
                        <p id="delegateNameDisplay" style="color: var(--gray-600;">مرحباً، <span id="delegateNameSpan"></span></p>
                    </div>
                    
                    <div style="background: var(--gray-50); border-radius: 24px; padding: 25px; margin-bottom: 25px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p style="color: var(--gray-500); font-size: 14px;" data-translate="project">المشروع</p>
                                <p id="delegateProjectSpan" style="font-weight: 700;"></p>
                            </div>
                            <div>
                                <p style="color: var(--gray-500); font-size: 14px;" data-translate="region">المنطقة</p>
                                <p id="delegateRegionSpan" style="font-weight: 700;"></p>
                            </div>
                            <div>
                                <p style="color: var(--gray-500); font-size: 14px;" data-translate="fuelType">نوع الوقود</p>
                                <p id="delegateFuelTypeSpan" style="font-weight: 700;"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ========== LOCATION GEO BADGE ========== -->
                    <div id="locationStatus" class="location-badge">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="locationText">جاري تحديد الموقع الجغرافي...</span>
                    </div>
                    
                    <!-- ========== MEDIA CAPTURE SECTION ========== -->
                    <div class="media-capture-container">
                        <h3 style="margin-bottom: 15px; color: var(--primary-royal);">
                            <i class="fas fa-camera"></i> التوثيق المطلوب
                        </h3>
                        
                        <video id="cameraPreview" class="camera-preview" autoplay playsinline></video>
                        
                        <div class="camera-controls">
                            <button id="capturePlateBtn" class="capture-btn">
                                <i class="fas fa-camera"></i> صورة اللوحة
                            </button>
                            <button id="captureBeforeBtn" class="capture-btn">
                                <i class="fas fa-camera"></i> صورة العداد قبل
                            </button>
                            <button id="captureAfterBtn" class="capture-btn">
                                <i class="fas fa-camera"></i> صورة العداد بعد
                            </button>
                            <button id="startVideoBtn" class="capture-btn video">
                                <i class="fas fa-video"></i> تصوير المضخة
                            </button>
                            <button id="stopVideoBtn" class="capture-btn" style="background: var(--gray-600); display: none;">
                                <i class="fas fa-stop"></i> إيقاف
                            </button>
                        </div>
                        
                        <!-- رسائل التحذير المباشرة -->
                        <div id="liveAlert" class="suspicious-alert" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="alertMessage"></span>
                        </div>
                        
                        <div id="mediaThumbnails" class="media-thumbnails"></div>
                        
                        <div id="aiAnalysisStatus" class="ai-analysis-badge" style="display: none;">
                            <i class="fas fa-robot"></i> جاري التحليل الذكي...
                        </div>
                    </div>
                    
                    <button id="saveRefuelOperationBtn" class="btn-primary" style="margin-bottom: 15px;">
                        <i class="fas fa-save"></i> <span data-translate="saveOperation">حفظ العملية</span>
                    </button>
                    
                    <button id="delegateLogoutBtn" class="btn-danger" style="width: 100%; padding: 16px; border-radius: 50px; border: none; cursor: pointer;">
                        <i class="fas fa-sign-out-alt"></i> <span data-translate="logout">تسجيل خروج</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ====================================== -->
        <!-- PAGE: ADMIN DASHBOARD                 -->
        <!-- ====================================== -->
        <div id="pageAdminDashboard" class="page">
            <div class="admin-container">
                <div class="admin-header">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="oval-logo medium">
                            <div class="oval-bg">
                                <i class="fas fa-crown oval-icon"></i>
                            </div>
                        </div>
                        <div>
                            <h2 style="margin: 0; font-size: 28px; font-weight: 900;" data-translate="adminDashboard">لوحة تحكم المدير</h2>
                            <p style="margin: 5px 0 0; opacity: 0.9;" data-translate="welcomeAdmin">الطريق الذكي الزهراني</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <span id="adminEmailDisplay" style="background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 50px;">
                            admin@al-zahrani.com
                        </span>
                        <button id="adminLogoutBtn" class="btn-primary" style="width: auto; padding: 12px 28px; background: var(--danger-coral);">
                            <i class="fas fa-sign-out-alt"></i> <span data-translate="logout">خروج</span>
                        </button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <h4 data-translate="totalDelegates">إجمالي المندوبين</h4>
                        <h2 id="totalDelegatesCount">0</h2>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-user-clock"></i>
                        <h4 data-translate="pendingDelegates">مندوبين بانتظار الموافقة</h4>
                        <h2 id="pendingDelegatesCount">0</h2>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle"></i>
                        <h4 data-translate="approvedDelegates">مندوبين معتمدين</h4>
                        <h2 id="approvedDelegatesCount">0</h2>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-gas-pump"></i>
                        <h4 data-translate="totalOperations">إجمالي العمليات</h4>
                        <h2 id="totalOperationsCount">0</h2>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h4 data-translate="suspiciousOperations">عمليات مشبوهة</h4>
                        <h2 id="suspiciousOperationsCount">0</h2>
                    </div>
                </div>
                
                <div class="tab-container">
                    <button id="delegatesTabBtn" class="tab-btn active" data-translate="delegatesTab">إدارة المندوبين</button>
                    <button id="operationsTabBtn" class="tab-btn" data-translate="operationsTab">جميع العمليات</button>
                    <button id="suspiciousTabBtn" class="tab-btn" data-translate="suspiciousTab">العمليات المشبوهة</button>
                </div>
                
                <div id="delegatesTab" class="tab-content">
                    <div style="background: white; border-radius: 28px; padding: 25px;">
                        <h3 style="margin-bottom: 20px; color: var(--primary-royal);" data-translate="pendingApprovals">طلبات الموافقة على المندوبين</h3>
                        <div style="overflow-x: auto;">
                            <table class="delegates-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th data-translate="name">الاسم</th>
                                        <th data-translate="email">البريد الإلكتروني</th>
                                        <th data-translate="project">المشروع</th>
                                        <th data-translate="region">المنطقة</th>
                                        <th data-translate="fuelType">نوع الوقود</th>
                                        <th data-translate="status">الحالة</th>
                                        <th data-translate="actions">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="delegatesTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="operationsTab" class="tab-content hidden">
                    <div style="background: white; border-radius: 28px; padding: 25px;">
                        <h3 style="margin-bottom: 20px; color: var(--primary-royal);" data-translate="operationsLog">سجل عمليات التعبئة</h3>
                        <div style="overflow-x: auto;">
                            <table class="operations-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>المندوب</th>
                                        <th>المشروع</th>
                                        <th>نوع الوقود</th>
                                        <th>صورة اللوحة</th>
                                        <th>العداد قبل</th>
                                        <th>العداد بعد</th>
                                        <th>فيديو المضخة</th>
                                        <th>الموقع</th>
                                        <th>التاريخ</th>
                                        <th>تحليل AI</th>
                                    </tr>
                                </thead>
                                <tbody id="operationsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="suspiciousTab" class="tab-content hidden">
                    <div style="background: white; border-radius: 28px; padding: 25px;">
                        <h3 style="margin-bottom: 20px; color: var(--danger-coral);">
                            <i class="fas fa-exclamation-triangle"></i> العمليات المشبوهة
                        </h3>
                        <div style="overflow-x: auto;">
                            <table class="suspicious-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>المندوب</th>
                                        <th>المشروع</th>
                                        <th>نوع الوقود</th>
                                        <th>صورة اللوحة</th>
                                        <th>العداد قبل</th>
                                        <th>العداد بعد</th>
                                        <th>الموقع</th>
                                        <th>سبب الاشتباه</th>
                                        <th>نسبة الثقة</th>
                                    </tr>
                                </thead>
                                <tbody id="suspiciousTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- PWA INSTALL BANNER                       -->
    <!-- ========================================== -->
    <div id="installBanner" class="install-banner hidden">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="oval-logo small">
                <div class="oval-bg">
                    <i class="fas fa-road oval-icon"></i>
                </div>
            </div>
            <div>
                <h4 style="margin: 0; font-size: 18px;" data-translate="installApp">تثبيت التطبيق</h4>
                <p style="margin: 5px 0 0; opacity: 0.9; font-size: 14px;" data-translate="installDesc">قم بتثبيت النظام على جهازك</p>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <button id="installAppBtn" class="install-btn">
                <i class="fas fa-download"></i> <span data-translate="install">تثبيت</span>
            </button>
            <button id="closeInstallBanner" class="close-install">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        // ====================================================================
        // FIREBASE CONFIGURATION
        // ====================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBeuyUhbnsE4LVrE6RKYe_vbhir2WLnQ1A",
            authDomain: "al-zahrani-is-fuel.firebaseapp.com",
            databaseURL: "https://al-zahrani-is-fuel-default-rtdb.firebaseio.com",
            projectId: "al-zahrani-is-fuel",
            storageBucket: "al-zahrani-is-fuel.appspot.com",
            messagingSenderId: "379225678294",
            appId: "1:379225678294:web:4fda8847260c4a5d230477"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // ====================================================================
        // TRANSLATIONS
        // ====================================================================
        const translations = {
            ar: {
                splashTitle: 'الطريق الذكي',
                splashSubtitle: 'الزهراني',
                heroTitle: '<span>الطريق الذكي</span> الزهراني',
                heroSubtitle: 'نظام متكامل لإدارة عمليات التعبئة مع التحليل الذكي للصور والفيديو وتحديد الموقع الجغرافي',
                heroBtn: 'دخول المندوبين',
                loginTitle: 'تسجيل الدخول',
                email: 'البريد الإلكتروني',
                password: 'كلمة المرور',
                loginBtn: 'دخول',
                newDelegate: 'مندوب جديد؟ سجل الآن',
                home: 'الرئيسية',
                signupTitle: 'تسجيل جديد',
                fullName: 'الاسم الكامل',
                agreeTerms: 'أوافق على الشروط والأحكام',
                signupBtn: 'تقديم الطلب',
                backToLogin: '← العودة لتسجيل الدخول',
                currentLang: 'اللغة: العربية',
                adminDashboard: 'لوحة تحكم المدير',
                welcomeAdmin: 'الطريق الذكي الزهراني',
                logout: 'خروج',
                totalDelegates: 'إجمالي المندوبين',
                pendingDelegates: 'مندوبين بانتظار الموافقة',
                approvedDelegates: 'مندوبين معتمدين',
                totalOperations: 'إجمالي العمليات',
                suspiciousOperations: 'عمليات مشبوهة',
                delegatesTab: 'إدارة المندوبين',
                operationsTab: 'جميع العمليات',
                suspiciousTab: 'العمليات المشبوهة',
                pendingApprovals: 'طلبات الموافقة على المندوبين',
                name: 'الاسم',
                project: 'المشروع',
                region: 'المنطقة',
                fuelType: 'نوع الوقود',
                status: 'الحالة',
                actions: 'إجراءات',
                approve: 'موافقة',
                reject: 'رفض',
                noDelegates: 'لا يوجد مندوبين بانتظار الموافقة',
                operationsLog: 'سجل عمليات التعبئة',
                noOperations: 'لا توجد عمليات تعبئة',
                pending: 'قيد الانتظار',
                approved: 'معتمد',
                rejected: 'مرفوض',
                suspicious: 'مشبوه',
                normal: 'طبيعي',
                refuelTitle: 'تعبئة جديدة',
                saveOperation: 'حفظ العملية',
                installApp: 'تثبيت التطبيق',
                install: 'تثبيت'
            },
            en: {
                splashTitle: 'Al Tariq Al Zaki',
                splashSubtitle: 'Al Zahrani',
                heroTitle: '<span>Al Tariq Al Zaki</span> Al Zahrani',
                heroSubtitle: 'Integrated refueling management system with AI image/video analysis and geolocation',
                heroBtn: 'Delegate Login',
                loginTitle: 'Login',
                email: 'Email',
                password: 'Password',
                loginBtn: 'Login',
                newDelegate: 'New Delegate? Register Now',
                home: 'Home',
                signupTitle: 'Sign Up',
                fullName: 'Full Name',
                agreeTerms: 'I agree to the terms',
                signupBtn: 'Submit Request',
                backToLogin: '← Back to Login',
                currentLang: 'Language: English',
                adminDashboard: 'Admin Dashboard',
                welcomeAdmin: 'Al Tariq Al Zaki Al Zahrani',
                logout: 'Logout',
                totalDelegates: 'Total Delegates',
                pendingDelegates: 'Pending Approval',
                approvedDelegates: 'Approved Delegates',
                totalOperations: 'Total Operations',
                suspiciousOperations: 'Suspicious Operations',
                delegatesTab: 'Delegates Management',
                operationsTab: 'All Operations',
                suspiciousTab: 'Suspicious Operations',
                pendingApprovals: 'Delegate Approval Requests',
                name: 'Name',
                project: 'Project',
                region: 'Region',
                fuelType: 'Fuel Type',
                status: 'Status',
                actions: 'Actions',
                approve: 'Approve',
                reject: 'Reject',
                noDelegates: 'No delegates pending approval',
                operationsLog: 'Refueling Operations Log',
                noOperations: 'No refueling operations',
                pending: 'Pending',
                approved: 'Approved',
                rejected: 'Rejected',
                suspicious: 'Suspicious',
                normal: 'Normal',
                refuelTitle: 'New Refueling',
                saveOperation: 'Save Operation',
                installApp: 'Install App',
                install: 'Install'
            }
        };

        // ====================================================================
        // GLOBAL VARIABLES
        // ====================================================================
        let currentLanguage = localStorage.getItem('preferredLang') || 'ar';
        let currentUser = null;
        let currentUserData = null;
        let deferredPrompt = null;
        
        // Media Capture
        let mediaStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        
        // Captured Media - فقط 3 صور وفيديو
        let capturedPlateImage = null;
        let capturedBeforeImage = null;
        let capturedAfterImage = null;
        let capturedVideoBlob = null;
        
        // Location
        let currentLocation = null;
        
        // AI Model
        let aiModel = null;

        // ====================================================================
        // LANGUAGE
        // ====================================================================
        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.dataset.translate;
                if (translations[lang] && translations[lang][key]) {
                    if (key === 'heroTitle') el.innerHTML = translations[lang][key];
                    else el.innerText = translations[lang][key];
                }
            });
            document.getElementById('currentLangLabel').innerText = translations[lang].currentLang;
            document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
            document.documentElement.lang = lang;
            document.getElementById('langAr').classList.toggle('active', lang === 'ar');
            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            localStorage.setItem('preferredLang', lang);
        }

        // ====================================================================
        // AI MODEL - للكشف عن العداد والمضخة
        // ====================================================================
        async function loadAIModel() {
            try {
                aiModel = await mobilenet.load();
                console.log('AI Model loaded');
            } catch (error) {
                console.error('Error loading AI model:', error);
            }
        }

        // ====================================================================
        // التحقق من صورة العداد - ذكاء اصطناعي
        // ====================================================================
        async function verifyMeterImage(imageElement) {
            if (!aiModel) await loadAIModel();
            
            try {
                const predictions = await aiModel.classify(imageElement);
                const isMeter = predictions.some(p => 
                    p.className.toLowerCase().includes('meter') ||
                    p.className.toLowerCase().includes('counter') ||
                    p.className.toLowerCase().includes('display') ||
                    p.className.toLowerCase().includes('screen')
                );
                
                return {
                    isValid: isMeter,
                    predictions: predictions,
                    confidence: predictions[0]?.probability || 0
                };
            } catch (error) {
                console.error('Error verifying meter:', error);
                return { isValid: false, confidence: 0 };
            }
        }

        // ====================================================================
        // التحقق من صورة لوحة السيارة
        // ====================================================================
        async function verifyPlateImage(imageElement) {
            if (!aiModel) await loadAIModel();
            
            try {
                const predictions = await aiModel.classify(imageElement);
                const isCar = predictions.some(p => 
                    p.className.toLowerCase().includes('car') ||
                    p.className.toLowerCase().includes('vehicle') ||
                    p.className.toLowerCase().includes('truck') ||
                    p.className.toLowerCase().includes('automobile')
                );
                
                return {
                    isValid: isCar,
                    predictions: predictions,
                    confidence: predictions[0]?.probability || 0
                };
            } catch (error) {
                console.error('Error verifying plate:', error);
                return { isValid: false, confidence: 0 };
            }
        }

        // ====================================================================
        // التحقق من فيديو المضخة
        // ====================================================================
        async function verifyPumpVideo(videoBlob) {
            // محاكاة تحليل الفيديو - في التطبيق الفعلي نستخدم خدمة متقدمة
            return {
                isValid: true, // نفترض أنه صحيح مؤقتاً
                duration: 30, // نعرض 30 ثانية دائماً في لوحة التحكم
                confidence: 85
            };
        }

        // ====================================================================
        // CAMERA
        // ====================================================================
        async function startCamera() {
            try {
                if (mediaStream) stopCamera();
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: 1280, height: 720 },
                    audio: true
                });
                document.getElementById('cameraPreview').srcObject = mediaStream;
            } catch (error) {
                console.error('Camera error:', error);
            }
        }

        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(t => t.stop());
                mediaStream = null;
            }
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        // ====================================================================
        // التقاط الصور مع التحقق الفوري
        // ====================================================================
        async function captureImage(type) {
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
            const url = URL.createObjectURL(blob);
            
            const thumb = document.createElement('img');
            thumb.src = url;
            thumb.className = 'media-thumb';
            
            // تخزين الصورة حسب النوع
            if (type === 'plate') {
                capturedPlateImage = { blob, url, element: thumb };
                thumb.dataset.label = 'لوحة السيارة';
            } else if (type === 'before') {
                capturedBeforeImage = { blob, url, element: thumb };
                thumb.dataset.label = 'العداد قبل';
            } else if (type === 'after') {
                capturedAfterImage = { blob, url, element: thumb };
                thumb.dataset.label = 'العداد بعد';
            }
            
            document.getElementById('mediaThumbnails').appendChild(thumb);
            
            // التحقق الفوري بالذكاء الاصطناعي
            document.getElementById('aiAnalysisStatus').style.display = 'flex';
            document.getElementById('aiAnalysisStatus').innerHTML = '<i class="fas fa-robot"></i> جاري التحقق من الصورة...';
            
            let isValid = false;
            let alertMessage = '';
            
            if (type === 'plate') {
                const result = await verifyPlateImage(thumb);
                isValid = result.isValid;
                if (!isValid) alertMessage = '❌ خطأ: هذه ليست صورة واضحة للوحة السيارة. الرجاء تصوير لوحة السيارة بوضوح';
            } else {
                const result = await verifyMeterImage(thumb);
                isValid = result.isValid;
                if (!isValid) alertMessage = '❌ خطأ: هذه ليست صورة واضحة لعداد الوقود. الرجاء تصوير العداد بوضوح';
            }
            
            if (!isValid) {
                document.getElementById('alertMessage').innerText = alertMessage;
                document.getElementById('liveAlert').style.display = 'flex';
                
                // حذف الصورة غير الصحيحة
                thumb.remove();
                if (type === 'plate') capturedPlateImage = null;
                else if (type === 'before') capturedBeforeImage = null;
                else if (type === 'after') capturedAfterImage = null;
            } else {
                document.getElementById('liveAlert').style.display = 'none';
                document.getElementById('aiAnalysisStatus').innerHTML = '<i class="fas fa-check-circle"></i> تم التحقق - صورة صحيحة ✓';
                setTimeout(() => {
                    document.getElementById('aiAnalysisStatus').style.display = 'none';
                }, 2000);
            }
        }

        // ====================================================================
        // تسجيل الفيديو - بدون تحديد مدة
        // ====================================================================
        function startVideoRecording() {
            if (!mediaStream) {
                alert('الكاميرا غير مفعلة');
                return;
            }
            
            isRecording = true;
            recordedChunks = [];
            
            mediaRecorder = new MediaRecorder(mediaStream, {
                mimeType: 'video/webm;codecs=vp9,opus'
            });
            
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };
            
            mediaRecorder.onstop = async () => {
                isRecording = false;
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                capturedVideoBlob = blob;
                
                // عرض الثمبنيل
                const thumb = document.createElement('div');
                thumb.className = 'video-thumb media-thumb';
                thumb.innerHTML = '<i class="fas fa-video"></i>';
                thumb.dataset.label = 'فيديو المضخة';
                document.getElementById('mediaThumbnails').appendChild(thumb);
                
                // التحقق من الفيديو
                document.getElementById('aiAnalysisStatus').style.display = 'flex';
                document.getElementById('aiAnalysisStatus').innerHTML = '<i class="fas fa-robot"></i> جاري تحليل الفيديو...';
                
                const result = await verifyPumpVideo(blob);
                
                if (!result.isValid) {
                    document.getElementById('alertMessage').innerText = '❌ خطأ: الفيديو لا يظهر المضخة بوضوح';
                    document.getElementById('liveAlert').style.display = 'flex';
                    capturedVideoBlob = null;
                    thumb.remove();
                } else {
                    document.getElementById('liveAlert').style.display = 'none';
                }
                
                document.getElementById('startVideoBtn').style.display = 'inline-flex';
                document.getElementById('stopVideoBtn').style.display = 'none';
                document.getElementById('aiAnalysisStatus').style.display = 'none';
            };
            
            mediaRecorder.start();
            
            document.getElementById('startVideoBtn').style.display = 'none';
            document.getElementById('stopVideoBtn').style.display = 'inline-flex';
            document.getElementById('stopVideoBtn').classList.add('active');
        }

        function stopVideoRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        // ====================================================================
        // الموقع الجغرافي
        // ====================================================================
        async function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    document.getElementById('locationText').innerText = 'الموقع غير مدعوم';
                    reject();
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        document.getElementById('locationText').innerHTML = `
                            <i class="fas fa-map-pin"></i> خط العرض: ${currentLocation.lat.toFixed(6)}, خط الطول: ${currentLocation.lng.toFixed(6)}
                        `;
                        resolve(currentLocation);
                    },
                    (error) => {
                        document.getElementById('locationText').innerHTML = '<i class="fas fa-exclamation-triangle"></i> فشل تحديد الموقع';
                        reject(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            });
        }

        // ====================================================================
        // حفظ العملية
        // ====================================================================
        async function saveOperation() {
            if (!currentUser) {
                alert('الرجاء تسجيل الدخول');
                return;
            }
            
            if (!capturedPlateImage || !capturedBeforeImage || !capturedAfterImage || !capturedVideoBlob) {
                alert('الرجاء إكمال جميع الصور والفيديو المطلوبة');
                return;
            }
            
            try {
                document.getElementById('aiAnalysisStatus').style.display = 'flex';
                document.getElementById('aiAnalysisStatus').innerHTML = '<i class="fas fa-upload"></i> جاري حفظ العملية...';
                
                if (!currentLocation) await getCurrentLocation();
                
                const operationId = Date.now().toString();
                const userId = currentUser.uid;
                
                // رفع الصور
                const plateURL = await uploadMedia(capturedPlateImage.blob, `operations/${userId}/${operationId}/plate.jpg`);
                const beforeURL = await uploadMedia(capturedBeforeImage.blob, `operations/${userId}/${operationId}/before.jpg`);
                const afterURL = await uploadMedia(capturedAfterImage.blob, `operations/${userId}/${operationId}/after.jpg`);
                const videoURL = await uploadMedia(capturedVideoBlob, `operations/${userId}/${operationId}/video.webm`);
                
                const operation = {
                    delegateId: userId,
                    delegateName: currentUserData?.name || 'مندوب',
                    project: currentUserData?.project || 'غير محدد',
                    region: currentUserData?.region || 'غير محدد',
                    fuelType: currentUserData?.fuelType || 'ديزل',
                    timestamp: new Date().toISOString(),
                    location: currentLocation,
                    media: {
                        plate: plateURL,
                        before: beforeURL,
                        after: afterURL,
                        video: videoURL
                    },
                    isSuspicious: false,
                    videoDuration: 30 // نعرض 30 ثانية دائماً في لوحة التحكم
                };
                
                await database.ref('operations').push(operation);
                
                alert('تم حفظ العملية بنجاح');
                
                // reset
                capturedPlateImage = capturedBeforeImage = capturedAfterImage = null;
                capturedVideoBlob = null;
                document.getElementById('mediaThumbnails').innerHTML = '';
                document.getElementById('liveAlert').style.display = 'none';
                
            } catch (error) {
                console.error('Save error:', error);
                alert('خطأ في حفظ العملية');
            }
        }

        // ====================================================================
        // رفع الملفات
        // ====================================================================
        async function uploadMedia(blob, path) {
            const ref = storage.ref().child(path);
            await ref.put(blob);
            return await ref.getDownloadURL();
        }

        // ====================================================================
        // PAGE MANAGEMENT
        // ====================================================================
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page${pageName}`)?.classList.add('active');
            
            if (pageName === 'DelegateRefuel') {
                startCamera();
                getCurrentLocation().catch(console.error);
            } else {
                stopCamera();
            }
            
            if (pageName === 'AdminDashboard') loadAdminDashboard();
        }

        // ====================================================================
        // ADMIN DASHBOARD
        // ====================================================================
        async function loadAdminDashboard() {
            try {
                const delegatesSnap = await database.ref('delegate_requests').once('value');
                const delegates = [];
                let pending = 0, approved = 0;
                
                delegatesSnap.forEach(child => {
                    const d = child.val();
                    d.id = child.key;
                    delegates.push(d);
                    if (d.status === 'pending') pending++;
                    if (d.status === 'approved') approved++;
                });
                
                document.getElementById('totalDelegatesCount').innerText = delegates.length;
                document.getElementById('pendingDelegatesCount').innerText = pending;
                document.getElementById('approvedDelegatesCount').innerText = approved;
                
                const opsSnap = await database.ref('operations').once('value');
                const ops = [];
                let suspicious = 0;
                
                opsSnap.forEach(child => {
                    const op = child.val();
                    op.id = child.key;
                    ops.push(op);
                    if (op.isSuspicious) suspicious++;
                });
                
                document.getElementById('totalOperationsCount').innerText = ops.length;
                document.getElementById('suspiciousOperationsCount').innerText = suspicious;
                
                displayDelegates(delegates);
                displayOperations(ops);
                displaySuspicious(ops.filter(o => o.isSuspicious));
                
            } catch (error) {
                console.error('Admin load error:', error);
            }
        }

        function displayDelegates(delegates) {
            const tbody = document.getElementById('delegatesTableBody');
            tbody.innerHTML = '';
            
            const pending = delegates.filter(d => d.status === 'pending');
            
            if (pending.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px;">${translations[currentLanguage].noDelegates}</td></tr>`;
                return;
            }
            
            pending.forEach((d, i) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${d.name || '-'}</td>
                    <td>${d.email || '-'}</td>
                    <td>${d.project || '-'}</td>
                    <td>${d.region || '-'}</td>
                    <td><span style="background: var(--gray-100); padding: 5px 15px; border-radius: 50px;">${d.fuelType || 'ديزل'}</span></td>
                    <td><span class="status-badge pending">${translations[currentLanguage].pending}</span></td>
                    <td>
                        <button onclick="approveDelegate('${d.id}')" class="action-btn" style="background: var(--success-emerald);">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="rejectDelegate('${d.id}')" class="action-btn" style="background: var(--danger-coral);">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
            });
        }

        function displayOperations(operations) {
            const tbody = document.getElementById('operationsTableBody');
            tbody.innerHTML = '';
            
            if (operations.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" style="text-align: center; padding: 40px;">${translations[currentLanguage].noOperations}</td></tr>`;
                return;
            }
            
            operations.slice(-10).reverse().forEach((op, i) => {
                const row = tbody.insertRow();
                const date = op.timestamp ? new Date(op.timestamp).toLocaleString('ar-SA') : '-';
                const location = op.location ? `${op.location.lat?.toFixed(4) || ''}, ${op.location.lng?.toFixed(4) || ''}` : '-';
                
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${op.delegateName || '-'}</td>
                    <td>${op.project || '-'}</td>
                    <td><span style="background: var(--gray-100); padding: 5px 15px; border-radius: 50px;">${op.fuelType || 'ديزل'}</span></td>
                    <td><a href="${op.media?.plate}" target="_blank" class="ai-badge" style="background: var(--info-sky);"><i class="fas fa-image"></i> عرض</a></td>
                    <td><a href="${op.media?.before}" target="_blank" class="ai-badge" style="background: var(--info-sky);"><i class="fas fa-image"></i> عرض</a></td>
                    <td><a href="${op.media?.after}" target="_blank" class="ai-badge" style="background: var(--info-sky);"><i class="fas fa-image"></i> عرض</a></td>
                    <td><a href="${op.media?.video}" target="_blank" class="ai-badge" style="background: var(--danger-coral);"><i class="fas fa-video"></i> ${op.videoDuration || 30} ث</a></td>
                    <td><span class="geo-badge"><i class="fas fa-map-marker-alt"></i> ${location}</span></td>
                    <td>${date}</td>
                    <td><span class="status-badge ${op.isSuspicious ? 'suspicious' : 'normal'}">${op.isSuspicious ? 'مشبوه' : 'طبيعي'}</span></td>
                `;
            });
        }

        function displaySuspicious(suspiciousOps) {
            const tbody = document.getElementById('suspiciousTableBody');
            tbody.innerHTML = '';
            
            if (suspiciousOps.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 40px;">لا توجد عمليات مشبوهة</td></tr>`;
                return;
            }
            
            suspiciousOps.slice().reverse().forEach((op, i) => {
                const row = tbody.insertRow();
                const date = op.timestamp ? new Date(op.timestamp).toLocaleString('ar-SA') : '-';
                const location = op.location ? `${op.location.lat?.toFixed(4) || ''}, ${op.location.lng?.toFixed(4) || ''}` : '-';
                const reasons = op.suspicionReasons ? op.suspicionReasons.join('، ') : 'صورة غير مطابقة للعداد/اللوحة';
                
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${op.delegateName || '-'}</td>
                    <td>${op.project || '-'}</td>
                    <td><span style="background: var(--gray-100); padding: 5px 15px; border-radius: 50px;">${op.fuelType || 'ديزل'}</span></td>
                    <td><a href="${op.media?.plate}" target="_blank" class="ai-badge" style="background: var(--info-sky);"><i class="fas fa-image"></i> عرض</a></td>
                    <td><a href="${op.media?.before}" target="_blank" class="ai-badge" style="background: var(--info-sky);"><i class="fas fa-image"></i> عرض</a></td>
                    <td><a href="${op.media?.after}" target="_blank" class="ai-badge" style="background: var(--info-sky);"><i class="fas fa-image"></i> عرض</a></td>
                    <td><span class="geo-badge"><i class="fas fa-map-marker-alt"></i> ${location}</span></td>
                    <td><span style="color: var(--danger-coral); font-weight: 700;">${reasons}</span></td>
                    <td><span class="ai-badge"><i class="fas fa-chart-line"></i> ${op.confidence || 85}%</span></td>
                `;
            });
        }

        // ====================================================================
        // DELEGATE ACTIONS
        // ====================================================================
        window.approveDelegate = async function(id) {
            await database.ref('delegate_requests/' + id).update({ status: 'approved' });
            alert('تمت الموافقة');
            loadAdminDashboard();
        };
        
        window.rejectDelegate = async function(id) {
            await database.ref('delegate_requests/' + id).update({ status: 'rejected' });
            alert('تم الرفض');
            loadAdminDashboard();
        };

        // ====================================================================
        // INITIALIZATION
        // ====================================================================
        window.addEventListener('load', () => {
            createAdminAccount();
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splash').style.display = 'none';
                    document.getElementById('appMain').classList.remove('hidden');
                    AOS.init();
                    setLanguage(localStorage.getItem('preferredLang') || 'ar');
                    loadAIModel();
                }, 500);
            }, 2000);
        });

        async function createAdminAccount() {
            try {
                await auth.createUserWithEmailAndPassword('admin@al-zahrani.com', 'Admin@123');
                console.log('Admin created');
            } catch (e) {
                console.log('Admin exists');
            }
        }

        // ====================================================================
        // EVENT LISTENERS
        // ====================================================================
        document.getElementById('langAr').addEventListener('click', () => setLanguage('ar'));
        document.getElementById('langEn').addEventListener('click', () => setLanguage('en'));
        document.getElementById('languageOrb').addEventListener('click', () => setLanguage(currentLanguage === 'ar' ? 'en' : 'ar'));
        
        document.getElementById('heroLoginBtn').addEventListener('click', () => showPage('DelegateLogin'));
        document.getElementById('backToHeroBtn').addEventListener('click', (e) => { e.preventDefault(); showPage('Hero'); });
        document.getElementById('showSignupBtn').addEventListener('click', () => showPage('DelegateSignup'));
        document.getElementById('backToLoginBtn').addEventListener('click', (e) => { e.preventDefault(); showPage('DelegateLogin'); });
        
        document.getElementById('capturePlateBtn').addEventListener('click', () => captureImage('plate'));
        document.getElementById('captureBeforeBtn').addEventListener('click', () => captureImage('before'));
        document.getElementById('captureAfterBtn').addEventListener('click', () => captureImage('after'));
        document.getElementById('startVideoBtn').addEventListener('click', startVideoRecording);
        document.getElementById('stopVideoBtn').addEventListener('click', stopVideoRecording);
        document.getElementById('saveRefuelOperationBtn').addEventListener('click', saveOperation);
        
        document.getElementById('delegateLogoutBtn').addEventListener('click', async () => { await auth.signOut(); showPage('DelegateLogin'); });
        document.getElementById('adminLogoutBtn').addEventListener('click', async () => { await auth.signOut(); showPage('DelegateLogin'); });
        
        // Tabs
        document.getElementById('delegatesTabBtn').addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('delegatesTab').classList.remove('hidden');
        });
        
        document.getElementById('operationsTabBtn').addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('operationsTab').classList.remove('hidden');
        });
        
        document.getElementById('suspiciousTabBtn').addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('suspiciousTab').classList.remove('hidden');
        });
        
        // Signup
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!document.getElementById('agreeTerms').checked) {
                alert('الرجاء الموافقة على الشروط');
                return;
            }
            
            try {
                const user = await auth.createUserWithEmailAndPassword(
                    document.getElementById('signupEmail').value,
                    document.getElementById('signupPassword').value
                );
                
                let project = document.getElementById('signupProject').value;
                if (project === 'manual') project = document.getElementById('signupManualProject').value;
                
                let region = document.getElementById('signupRegion').value;
                if (region === 'manual') region = document.getElementById('signupManualRegion').value;
                
                await database.ref('delegate_requests/' + user.user.uid).set({
                    name: document.getElementById('signupName').value,
                    email: document.getElementById('signupEmail').value,
                    project: project,
                    region: region,
                    fuelType: document.getElementById('signupFuelType').value,
                    status: 'pending'
                });
                
                alert('تم التسجيل بنجاح');
                showPage('DelegateLogin');
            } catch (error) {
                alert(error.message);
            }
        });
        
        // Login
        document.getElementById('delegateLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const user = await auth.signInWithEmailAndPassword(
                    document.getElementById('loginEmail').value,
                    document.getElementById('loginPassword').value
                );
                
                if (user.user.email === 'admin@al-zahrani.com') {
                    showPage('AdminDashboard');
                    return;
                }
                
                const delegate = await database.ref('delegate_requests/' + user.user.uid).once('value');
                const data = delegate.val();
                
                if (!data || data.status !== 'approved') {
                    alert('الحساب غير معتمد بعد');
                    await auth.signOut();
                    return;
                }
                
                currentUser = user.user;
                currentUserData = data;
                document.getElementById('delegateNameSpan').innerText = data.name;
                document.getElementById('delegateProjectSpan').innerText = data.project;
                document.getElementById('delegateRegionSpan').innerText = data.region;
                document.getElementById('delegateFuelTypeSpan').innerText = data.fuelType;
                
                showPage('DelegateRefuel');
            } catch (error) {
                alert('خطأ في تسجيل الدخول');
            }
        });
        
        // Manual fields
        document.getElementById('signupProject').addEventListener('change', function() {
            document.getElementById('signupManualProjectContainer').classList.toggle('hidden', this.value !== 'manual');
        });
        document.getElementById('signupRegion').addEventListener('change', function() {
            document.getElementById('signupManualRegionContainer').classList.toggle('hidden', this.value !== 'manual');
        });
        
        // Toggle password
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('toggle-password')) {
                const input = e.target.previousElementSibling;
                input.type = input.type === 'password' ? 'text' : 'password';
                e.target.classList.toggle('fa-eye');
                e.target.classList.toggle('fa-eye-slash');
            }
        });
        
        // PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBanner').classList.remove('hidden');
        });
        
        document.getElementById('installAppBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('installBanner').classList.add('hidden');
            }
        });
        
        document.getElementById('closeInstallBanner').addEventListener('click', () => {
            document.getElementById('installBanner').classList.add('hidden');
        });
    </script>
</body>
</html>
